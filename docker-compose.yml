# =============================================================================
# docker-compose.yml â€“ Local development environment
# Spins up the API + dependencies (SQL Server, Redis, Seq for logging)
# =============================================================================

services:
  api:
    build:
      context: ./src/SmartHealth.Appointments.API
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ConnectionStrings__SqlServer: "Server=sqlserver,1433;Database=SmartHealthAppointments;User Id=sa;Password=YourStrong!Passw0rd;TrustServerCertificate=true"
      ConnectionStrings__Redis: "redis:6379"
      Features__UseInMemoryBus: "true"
      Features__SagaOrchestration: "true"
    depends_on:
      sqlserver:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  prescriptions-api:
    build:
      context: ./src/prescriptions.api
      dockerfile: Dockerfile
    ports:
      - "8082:8000"
    environment:
      ENVIRONMENT: development
      DEBUG: "true"
      DATABASE_URL: "postgresql+asyncpg://postgres:postgres@postgres:5432/smarthealth_prescriptions"
      REDIS_URL: "redis://redis:6379"
      USE_IN_MEMORY_BUS: "true"
      ENABLE_REDIS_CACHE: "false"
      ENABLE_LLM_SUGGESTIONS: "false"
      OPENAI_API_KEY: ""
      SECRET_KEY: "dev-secret-key"
      MODEL_STORAGE_PATH: "/app/models"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  payments-api:
    build:
      context: ./src/payments.api
      dockerfile: Dockerfile
    ports:
      - "8081:8080"
    environment:
      PORT: "8080"
      ENVIRONMENT: development
      DATABASE_URL: "postgres://postgres:postgres@postgres:5432/smarthealth_payments?sslmode=disable"
      USE_IN_MEMORY_BROKER: "true"
      STRIPE_SECRET_KEY: "sk_test_placeholder"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      SA_PASSWORD: "YourStrong!Passw0rd"
      ACCEPT_EULA: "Y"
    ports:
      - "1433:1433"
    volumes:
      - sqlserver_data:/var/opt/mssql
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'YourStrong!Passw0rd' -Q 'SELECT 1' -No 2>/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  audit-api:
    build:
      context: ./src/audit.api
      dockerfile: Dockerfile
    ports:
      - "8082:8082"
    environment:
      DATABASE_URL: "jdbc:postgresql://postgres:5432/smarthealth_audit"
      DATABASE_USERNAME: postgres
      DATABASE_PASSWORD: postgres
      AZURE_SERVICE_BUS_CONNECTION_STRING: ""
      JWT_SECRET: "change-me-in-production-use-a-long-secret"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  shipment-api:
    build:
      context: ./src/shipment.api
      dockerfile: Dockerfile
    ports:
      - "8083:3000"
    environment:
      NODE_ENV: development
      DATABASE_URL: "postgresql://postgres:postgres@postgres:5432/smarthealth_shipment?schema=public"
      REDIS_URL: "redis://redis:6379"
      USE_IN_MEMORY_BUS: "true"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: smarthealth_payments
      POSTGRES_MULTIPLE_DATABASES: "smarthealth_payments,smarthealth_prescriptions,smarthealth_shipment,smarthealth_audit"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./infra/postgres-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

volumes:
  sqlserver_data:
  redis_data:
  postgres_data:
